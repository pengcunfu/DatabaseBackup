# GitHub Actions - è‡ªåŠ¨æž„å»ºå’Œå‘å¸ƒ Windows åº”ç”¨ç¨‹åº
name: Build and Release Windows App

# è§¦å‘æ¡ä»¶
on:
  push:
    tags:
      - 'v*'  # å½“æŽ¨é€ v1.0.0, v2.0.0 ç­‰æ ‡ç­¾æ—¶è§¦å‘
  workflow_dispatch:  # å…è®¸æ‰‹åŠ¨è§¦å‘

jobs:
  build-windows:
    runs-on: windows-latest

    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4

    - name: è®¾ç½® Python çŽ¯å¢ƒ
      uses: actions/setup-python@v5
      with:
        python-version: '3.9'

    - name: å®‰è£…ä¾èµ–
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt

    - name: å®‰è£… Nuitka å’Œæž„å»ºå·¥å…·
      run: |
        pip install nuitka imageio
        pip install pywin32  # ç”¨äºŽæž„å»ºå®‰è£…ç¨‹åº

    - name: å®‰è£… MSVC æž„å»ºå·¥å…·
      uses: ilammy/msvc-dev-cmd@v1
      with:
        arch: x64

    - name: æž„å»ºåº”ç”¨ç¨‹åº
      run: |
        python scripts/build.py
      shell: cmd

    - name: éªŒè¯ç¼–è¯‘ç»“æžœ
      run: |
        if not exist "dist\main.dist\DatabaseBackup.exe" (
          echo Error: DatabaseBackup.exe not found
          exit /b 1
        )
        echo Build verification passed
      shell: cmd

    - name: è®¾ç½® Inno Setup
      run: |
        echo "Downloading Inno Setup..."
        powershell -Command "Invoke-WebRequest -Uri 'https://files.jrsoftware.org/is/6/innosetup-6.2.2.exe' -OutFile 'innosetup.exe'"
        echo "Installing Inno Setup..."
        .\innosetup.exe /VERYSILENT /SUPPRESSMSGBOXES /NORESTART /SP-
        echo "Inno Setup installation completed"
      shell: cmd

    - name: æž„å»ºå®‰è£…ç¨‹åº
      run: |
        python scripts/build_installer.py
      shell: cmd

    - name: éªŒè¯å®‰è£…ç¨‹åº
      run: |
        if not exist "output\DatabaseBackup-Setup-1.0.0.exe" (
          echo Error: Installer not found
          exit /b 1
        )
        echo Installer verification passed
      shell: cmd

    - name: èŽ·å–ç‰ˆæœ¬å·
      id: get_version
      run: |
        if "%GITHUB_REF%" == "refs/heads/main" (
          set VERSION=dev-latest
        ) else (
          set VERSION=%GITHUB_REF:~10%
        )
        echo version=%VERSION% >> %GITHUB_OUTPUT%
      shell: cmd

    - name: åˆ›å»ºå‘å¸ƒåŒ…
      run: |
        mkdir release
        copy output\DatabaseBackup-Setup-%VERSION%.exe release\DatabaseBackup-Setup-%VERSION%.exe
        copy dist\main.dist\DatabaseBackup.exe release\DatabaseBackup.exe
      shell: cmd

    - name: åˆ›å»ºåŽ‹ç¼©åŒ…ï¼ˆå¯é€‰ï¼‰
      run: |
        powershell -Command "Compress-Archive -Path 'dist\main.dist\*' -DestinationPath 'release\DatabaseBackup-Portable-${{ steps.get_version.outputs.version }}.zip'"
      shell: cmd

    - name: ä¸Šä¼ æž„å»ºäº§ç‰©
      uses: actions/upload-artifact@v4
      with:
        name: DatabaseBackup-Windows-${{ steps.get_version.outputs.version }}
        path: release/
        retention-days: 30

    # ä»…åœ¨æŽ¨é€æ ‡ç­¾æ—¶åˆ›å»º GitHub Release
    - name: åˆ›å»º GitHub Release
      if: startsWith(github.ref, 'refs/tags/')
      uses: softprops/action-gh-release@v1
      with:
        files: |
          release/*.exe
          release/*.zip
        draft: false
        prerelease: false
        generate_release_notes: true
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    - name: æž„å»ºæ‘˜è¦
      if: always()
      run: |
        # è¯»å– RELEASE_TEMPLATE.md å¹¶ç”Ÿæˆæž„å»ºæ‘˜è¦
        if [ -f ".github/RELEASE_TEMPLATE.md" ]; then
          # æ›¿æ¢æ¨¡æ¿ä¸­çš„å ä½ç¬¦
          VERSION=${{ steps.get_version.outputs.version }}
          DATE=$(date +%Y-%m-%d)

          # å¤„ç†å¯æ‰§è¡Œæ–‡ä»¶åï¼ˆä»Ž main.dist ç›®å½•ä¸­èŽ·å–ï¼‰
          if [ -f "dist/main.dist/DatabaseBackup.exe" ]; then
            EXE_NAME="DatabaseBackup.exe"
          else
            EXE_NAME="main.exe"
          fi

          # è¯»å–æ¨¡æ¿å¹¶æ›¿æ¢å ä½ç¬¦
          sed -e "s/{VERSION}/$VERSION/g" \
              -e "s/{DATE}/$DATE/g" \
              -e "s/main\.exe/$EXE_NAME/g" \
              -e "s/{PREV_VERSION}/$VERSION/g" \
              .github/RELEASE_TEMPLATE.md > $GITHUB_STEP_SUMMARY

          # æ·»åŠ æž„å»ºä¿¡æ¯
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ—ï¸ æž„å»ºä¿¡æ¯" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **ç‰ˆæœ¬:** $VERSION" >> $GITHUB_STEP_SUMMARY
          echo "- **å¹³å°:** Windows" >> $GITHUB_STEP_SUMMARY
          echo "- **çŠ¶æ€:** ${{ job.status }}" >> $GITHUB_STEP_SUMMARY
          echo "- **å¯æ‰§è¡Œæ–‡ä»¶:** $EXE_NAME" >> $GITHUB_STEP_SUMMARY
          echo "- **å·¥ä½œæµ:** ${{ github.workflow }}" >> $GITHUB_STEP_SUMMARY
          echo "- **è¿è¡ŒID:** [${{ github.run_id }}](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})" >> $GITHUB_STEP_SUMMARY
        else
          # å¦‚æžœæ¨¡æ¿æ–‡ä»¶ä¸å­˜åœ¨ï¼Œä½¿ç”¨é»˜è®¤æ ¼å¼
          echo "## æž„å»ºå®Œæˆ :rocket:" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**ç‰ˆæœ¬:** ${{ steps.get_version.outputs.version }}" >> $GITHUB_STEP_SUMMARY
          echo "**å¹³å°:** Windows" >> $GITHUB_STEP_SUMMARY
          echo "**çŠ¶æ€:** ${{ job.status }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ä¸‹è½½æ–‡ä»¶:" >> $GITHUB_STEP_SUMMARY
          echo "- DatabaseBackup-Setup-${{ steps.get_version.outputs.version }}.exe (å®‰è£…ç¨‹åº)" >> $GITHUB_STEP_SUMMARY
          echo "- DatabaseBackup-Portable-${{ steps.get_version.outputs.version }}.zip (ä¾¿æºç‰ˆ)" >> $GITHUB_STEP_SUMMARY
        fi
      shell: bash
