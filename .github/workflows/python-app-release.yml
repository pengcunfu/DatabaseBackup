# GitHub Actions - 自动构建和发布 Windows 应用程序
name: Build and Release Windows App

# 触发条件
on:
  push:
    tags:
      - 'v*'  # 当推送 v1.0.0, v2.0.0 等标签时触发
  workflow_dispatch:  # 允许手动触发

jobs:
  build-windows:
    runs-on: windows-latest

    steps:
    - name: 检出代码
      uses: actions/checkout@v4

    - name: 设置 Python 环境
      uses: actions/setup-python@v5
      with:
        python-version: '3.9'

    - name: 安装依赖
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt

    - name: 安装 Nuitka 和构建工具
      run: |
        pip install nuitka imageio
        pip install pywin32  # 用于构建安装程序

    - name: 安装 MSVC 构建工具
      uses: ilammy/msvc-dev-cmd@v1
      with:
        arch: x64

    - name: 构建应用程序
      run: |
        python scripts/build.py
      shell: cmd

    - name: 验证编译结果
      run: |
        if not exist "dist\main.dist\main.exe" (
          echo Error: main.exe not found
          exit /b 1
        )
        echo Build verification passed
      shell: cmd

    - name: 设置 Inno Setup
      run: |
        echo "Downloading Inno Setup..."
        powershell -Command "Invoke-WebRequest -Uri 'https://files.jrsoftware.org/is/6/innosetup-6.2.2.exe' -OutFile 'innosetup.exe'"
        echo "Installing Inno Setup..."
        .\innosetup.exe /VERYSILENT /SUPPRESSMSGBOXES /NORESTART /SP-
        echo "Inno Setup installation completed"
      shell: cmd

    - name: 构建安装程序
      run: |
        python scripts/build_installer.py
      shell: cmd

    - name: 验证安装程序
      run: |
        if not exist "output\DatabaseBackup-Setup-1.0.0.exe" (
          echo Error: Installer not found
          exit /b 1
        )
        echo Installer verification passed
      shell: cmd

    - name: 获取版本号
      id: get_version
      run: |
        if "%GITHUB_REF%" == "refs/heads/main" (
          set VERSION=dev-latest
        ) else (
          set VERSION=%GITHUB_REF:~10%
        )
        echo version=%VERSION% >> %GITHUB_OUTPUT%
      shell: cmd

    - name: 创建发布包
      run: |
        mkdir release
        copy output\DatabaseBackup-Setup-1.0.0.exe release\DatabaseBackup-Setup-${{ steps.get_version.outputs.version }}.exe
        copy dist\main.dist\main.exe release\main.exe
      shell: cmd

    - name: 创建压缩包（可选）
      run: |
        powershell -Command "Compress-Archive -Path 'dist\main.dist\*' -DestinationPath 'release\DatabaseBackup-Portable-${{ steps.get_version.outputs.version }}.zip'"
      shell: cmd

    - name: 上传构建产物
      uses: actions/upload-artifact@v4
      with:
        name: DatabaseBackup-Windows-${{ steps.get_version.outputs.version }}
        path: release/
        retention-days: 30

    # 仅在推送标签时创建 GitHub Release
    - name: 创建 GitHub Release
      if: startsWith(github.ref, 'refs/tags/')
      uses: softprops/action-gh-release@v1
      with:
        files: |
          release/*.exe
          release/*.zip
        draft: false
        prerelease: false
        generate_release_notes: true
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    - name: 构建摘要
      if: always()
      run: |
        echo "## 构建完成 :rocket:" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**版本:** ${{ steps.get_version.outputs.version }}" >> $GITHUB_STEP_SUMMARY
        echo "**平台:** Windows" >> $GITHUB_STEP_SUMMARY
        echo "**状态:** ${{ job.status }}" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### 下载文件:" >> $GITHUB_STEP_SUMMARY
        echo "- DatabaseBackup-Setup-${{ steps.get_version.outputs.version }}.exe (安装程序)" >> $GITHUB_STEP_SUMMARY
        echo "- DatabaseBackup-Portable-${{ steps.get_version.outputs.version }}.zip (便携版)" >> $GITHUB_STEP_SUMMARY
      shell: bash
